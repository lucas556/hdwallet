<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>多链账户与地址推导（选择链 → 账户 xprv/xpub + 地址0）</title>
<style>
  :root{--bg:#0b1220;--card:#0f1724;--line:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--good:#10b981;--bad:#ef4444}
  html,body{background:var(--bg);color:var(--text);margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px;overflow-x:hidden}
  h1{margin:0 0 8px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .row{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;align-items:center}
  input,select,button{
    background:#0c152a;border:1px solid #243250;color:var(--text);
    border-radius:10px;padding:10px 12px
  }
  button{cursor:pointer} button:hover{filter:brightness(1.08)}
  pre{
    background:#0a1224;border:1px solid #1d2a44;border-radius:10px;
    padding:12px;max-width:100%;white-space:pre-wrap;word-break:break-all;overflow-wrap:anywhere;overflow:auto
  }
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .ok{color:var(--good)} .err{color:var(--bad)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>多链账户与地址推导（BIP39 → BIP32，纯前端 / WebCrypto）</h1>
  <div class="muted">选择目标链后，一键生成该链的账户级扩展键与 index 0 地址（或 EOS 公钥）。</div>

  <div class="card">
    <h3>① 生成助记词 & Seed</h3>
    <div class="row">
      <label>词数：
        <select id="sl-words">
          <option value="128">12 词（128-bit）</option>
          <option value="256">24 词（256-bit）</option>
        </select>
      </label>
      <label>可选 passphrase：
        <input id="in-pass" placeholder="推荐留空（BIP39 passphrase）"/>
      </label>
      <button id="btn-gen" disabled>生成助记词并推导 Seed & Root</button>
      <span id="mn-tip" class="muted"></span>
    </div>
    <div id="mnemo-box" style="display:none">
      <div class="row"><b>助记词：</b></div>
      <pre id="out-mnemonic" class="mono"></pre>
      <div class="row"><b>Seed (64B hex)：</b></div>
      <pre id="out-seed" class="mono"></pre>
    </div>
    <div id="root-box" class="grid-2" style="display:none">
      <div><div class="row"><b>Root xprv (m)：</b></div><pre id="out-root-xprv" class="mono"></pre></div>
      <div><div class="row"><b>Root xpub (m)：</b></div><pre id="out-root-xpub" class="mono"></pre></div>
    </div>
  </div>

  <div class="card">
    <h3>② 选择链并生成账户 + 地址 0</h3>
    <div class="row">
      <label>目标链：
        <select id="sl-chain">
          <option value="BTC">BTC（BIP84，zprv/zpub，地址 bc1q）</option>
          <option value="ETH">ETH（m/44'/60'/0'/0，EIP-55）</option>
          <option value="TRX">TRON（m/44'/195'/0'/0，Base58Check）</option>
          <option value="EOS">EOS（m/44'/194'/0'/0，EOS 公钥 + PUB_K1_）</option>
        </select>
      </label>
      <button id="btn-derive-chain" disabled>生成所选链账户 + 地址 0</button>
      <span id="ch-tip" class="muted"></span>
    </div>

    <div id="acct-box" style="display:none">
      <div class="row" id="acct-path-line"></div>
      <div class="grid-2">
        <div>
          <div class="row"><b id="lbl-xprv">账户 xprv：</b></div>
          <pre id="out-xprv" class="mono"></pre>
        </div>
        <div>
          <div class="row"><b id="lbl-xpub">账户 xpub：</b></div>
          <pre id="out-xpub" class="mono"></pre>
        </div>
      </div>
      <div class="row" id="addr-title"></div>
      <pre id="out-addr" class="mono"></pre>
      <!-- EOS K1 -->
      <div id="eos-k1-box" style="display:none;margin-top:8px;">
        <div class="row"><b>K1 公钥（PUB_K1_…）：</b></div>
        <pre id="out-eos-k1" class="mono"></pre>
      </div>
    </div>
  </div>
</div>

<script type="module">
// ---- 依赖 ----
import * as secp from 'https://esm.run/@noble/secp256k1@1.7.1';
import { keccak_256 } from 'https://esm.sh/@noble/hashes@1.4.0/sha3';
import * as rmd160 from 'https://esm.sh/@noble/hashes@1.4.0/ripemd160';

// ---- 工具函数 ----
const te=new TextEncoder(), td=new TextDecoder();
const $=id=>document.getElementById(id);
const curveN=secp.CURVE.n;

function bytesToHex(u8){return Array.from(u8).map(x=>x.toString(16).padStart(2,'0')).join('');}
function hexToBytes(hex){const h=hex.replace(/^0x/,'');return new Uint8Array(h.match(/.{1,2}/g).map(x=>parseInt(x,16)));}
function concatBytes(...arrs){let len=0;for(const a of arrs)len+=a.length;const out=new Uint8Array(len);let off=0;for(const a of arrs){out.set(a,off);off+=a.length;}return out;}
async function wc_sha256(b){return new Uint8Array(await crypto.subtle.digest('SHA-256',b));}
async function hash160_async(data){return rmd160.ripemd160(await wc_sha256(data));}
function base58encode(data){const ALPH='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';let x=BigInt('0x'+bytesToHex(data)),out='';while(x>0n){const m=x%58n;out=ALPH[Number(m)]+out;x/=58n;}for(let i=0;i<data.length&&data[i]===0;i++)out='1'+out;return out||'1';}
async function hmacSHA512(keyBytes,dataBytes){const key=await crypto.subtle.importKey('raw',keyBytes,{name:'HMAC',hash:'SHA-512'},false,['sign']);const sig=await crypto.subtle.sign('HMAC',key,dataBytes);return new Uint8Array(sig);}
async function eosLegacyPub(pub){const chk=rmd160.ripemd160(pub).slice(0,4);return 'EOS'+base58encode(concatBytes(pub,chk));}
function eosK1Pub(pub){const chk=rmd160.ripemd160(concatBytes(pub,te.encode('K1'))).slice(0,4);return 'PUB_K1_'+base58encode(concatBytes(pub,chk));}
function ethChecksumFromPub(pub){const un=secp.Point.fromHex(pub).toRawBytes(false).slice(1);const h=keccak_256(un).slice(12);const lower=bytesToHex(h).toLowerCase();const hash=bytesToHex(keccak_256(new TextEncoder().encode(lower)));let out='0x';for(let i=0;i<lower.length;i++)out+=(parseInt(hash[i],16)>=8)?lower[i].toUpperCase():lower[i];return out;}

// ---- 简化 PBKDF2 / Root 流程示例 ----
async function bip32RootFromSeed(seed){
  const I=await hmacSHA512(te.encode('Bitcoin seed'),seed);
  const IL=I.slice(0,32),IR=I.slice(32);
  const pub=secp.getPublicKey(IL,true);
  return {key:IL,chain:IR,pub,depth:0,child:0,parentFP:new Uint8Array(4)};
}
async function CKDpriv(n,i,h){const idx=h?(i|0x80000000):i;const data=h?concatBytes(new Uint8Array([0]),n.key,new Uint8Array([idx>>>24,idx>>>16,idx>>>8,idx])):concatBytes(secp.getPublicKey(n.key,true),new Uint8Array([idx>>>24,idx>>>16,idx>>>8,idx]));const I=await hmacSHA512(n.chain,data);const IL=I.slice(0,32),IR=I.slice(32);const ki=(BigInt('0x'+bytesToHex(IL))+BigInt('0x'+bytesToHex(n.key)))%curveN;return {key:hexToBytes(ki.toString(16).padStart(64,'0')),chain:IR,pub:secp.getPublicKey(hexToBytes(ki.toString(16).padStart(64,'0')),true),depth:n.depth+1,child:idx,parentFP:await hash160_async(n.pub).then(v=>v.slice(0,4))};}
async function CKDpub(pub,chain,depth,parentFP,i){const data=concatBytes(pub,new Uint8Array([i>>>24,i>>>16,i>>>8,i]));const I=await hmacSHA512(chain,data);const IL=I.slice(0,32),IR=I.slice(32);const il=BigInt('0x'+bytesToHex(IL));const pt=secp.Point.fromHex(pub).add(secp.Point.BASE.multiply(il));return {pub:pt.toRawBytes(true),chain:IR,depth:depth+1,parentFP,child:i};}

// ---- 主逻辑 ----
document.addEventListener('DOMContentLoaded',()=>{
  const btnGen=$('btn-gen'),btnDerive=$('btn-derive-chain'),tip=$('ch-tip');
  btnGen.disabled=false;

  btnGen.addEventListener('click',async()=>{
    // 模拟：固定助记词seed
    const seed=crypto.getRandomValues(new Uint8Array(64));
    window.gRoot=await bip32RootFromSeed(seed);
    $('out-root-xprv').textContent='(略)...';
    $('out-root-xpub').textContent='(略)...';
    $('root-box').style.display='block';
    btnDerive.disabled=false;
  });

  btnDerive.addEventListener('click',async()=>{
    const chain=$('sl-chain').value;
    const root=window.gRoot;
    if(!root)return alert('请先生成Seed');
    $('acct-box').style.display='none';
    $('eos-k1-box').style.display='none';
    tip.textContent='';

    let n=root;
    if(chain==='BTC'){n=await CKDpriv(n,84,true);n=await CKDpriv(n,0,true);n=await CKDpriv(n,0,true);}
    else if(chain==='ETH'){n=await CKDpriv(n,44,true);n=await CKDpriv(n,60,true);n=await CKDpriv(n,0,true);n=await CKDpriv(n,0,false);}
    else if(chain==='TRX'){n=await CKDpriv(n,44,true);n=await CKDpriv(n,195,true);n=await CKDpriv(n,0,true);n=await CKDpriv(n,0,false);}
    else if(chain==='EOS'){n=await CKDpriv(n,44,true);n=await CKDpriv(n,194,true);n=await CKDpriv(n,0,true);n=await CKDpriv(n,0,false);}

    $('out-xprv').textContent='(模拟XPRV)...';
    $('out-xpub').textContent='(模拟XPUB)...';
    $('acct-path-line').textContent=`路径: ${chain}`;
    $('acct-box').style.display='block';

    if(chain==='EOS'){
      const a0=await CKDpub(n.pub,n.chain,n.depth,n.parentFP,0);
      const eosLegacy=await eosLegacyPub(a0.pub);
      const eosK1=eosK1Pub(a0.pub);
      $('addr-title').textContent='EOS 公钥：';
      $('out-addr').textContent=eosLegacy;
      $('eos-k1-box').style.display='block';
      $('out-eos-k1').textContent=eosK1;
    }else{
      $('addr-title').textContent='地址 0：';
      $('out-addr').textContent='示例地址 ('+chain+')';
    }

    tip.textContent='完成。';
  });
});
</script>
</body>
</html>
