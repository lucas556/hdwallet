<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BIP-39 助记词与 Seed 生成（english.txt 单次校验）</title>
<style>
  :root{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--line:#1f2937}
  html,body{background:var(--bg);color:var(--text);margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}
  .wrap{max-width:900px;margin:28px auto;padding:18px}
  h1{margin:0 0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px 14px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0}
  label{color:var(--muted)}
  input,select,textarea{
    background:#0c1427;border:1px solid #223150;color:var(--text);
    border-radius:10px;padding:10px;outline:none
  }
  select{min-width:160px}
  input[type="text"]{min-width:300px}
  textarea{width:100%;min-height:96px;resize:vertical}
  button{
    background:linear-gradient(180deg,#0f172a,#0a1326);border:1px solid #223150;color:var(--text);
    padding:10px 14px;border-radius:12px;cursor:pointer
  }
  button:hover{filter:brightness(1.06)}
  .muted{color:var(--muted)} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
  .hint{font-size:13px;color:var(--muted)}
  .copy{margin-left:8px}
  .err{color:#ef4444} .ok{color:#10b981}
</style>
</head>
<body>
<div class="wrap">
  <h1>BIP-39 助记词与 Seed 生成（english.txt 单次校验）</h1>

  <div class="card">
    <div class="row kv">
      <label for="sel-strength">助记词长度</label>
      <select id="sel-strength">
        <option value="128">12 词（128-bit）</option>
        <option value="160">15 词（160-bit）</option>
        <option value="192">18 词（192-bit）</option>
        <option value="224">21 词（224-bit）</option>
        <option value="256">24 词（256-bit）</option>
      </select>

      <label for="pp">BIP-39 passphrase</label>
      <input id="pp" type="text" placeholder="可选：更安全，但需牢记" />

      <span></span>
      <div class="hint">seed = PBKDF2-HMAC-SHA512( 口令=助记词，salt='mnemonic'+passphrase，迭代=2048 )</div>
    </div>

    <div class="row">
      <button id="btn-gen">生成助记词 & Seed</button>
      <span id="tip" class="muted"></span>
    </div>

    <div id="wl-tip" class="hint"></div>
  </div>

  <div class="card">
    <div class="row">
      <label style="min-width:140px">助记词</label>
      <button class="copy" id="copy-mn">复制</button>
    </div>
    <textarea id="mnemo" class="mono" readonly></textarea>
  </div>

  <div class="card">
    <div class="row">
      <label style="min-width:140px">BIP-39 Seed (hex, 64 字节)</label>
      <button class="copy" id="copy-seed">复制</button>
    </div>
    <textarea id="seedhex" class="mono" readonly></textarea>
  </div>

  <div class="hint">请把 <span class="mono">english.txt</span>（官方 2048 词表）放在本页面同目录下。</div>
</div>

<script type="module">
/* ========== 工具 ========== */
const te = new TextEncoder(), td = new TextDecoder();
const EXPECTED_WL_SHA256 = '2f5eed53a4727b4bf8880d8f3f199efc90e58503646d9ff8eff3a2ed3b24dbda';

let WORDLIST = null;   // 缓存加载后的词表（只校验一次）
let WL_READY = false;  // 是否已通过校验

function hex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function sha256(buf){ return new Uint8Array(await crypto.subtle.digest('SHA-256', buf)); }
async function sha256HexOfString(s){ return hex(await sha256(te.encode(s))); }
function bytesToBin(u8){ return Array.from(u8).map(b=>b.toString(2).padStart(8,'0')).join(''); }
function normalizeWordlistText(raw){ let t=raw.replace(/\r\n/g,'\n'); t=t.replace(/\n+$/,''); return t+'\n'; }

/* 单次加载 + 校验（后续生成直接复用） */
async function ensureWordlist() {
  if (WL_READY && Array.isArray(WORDLIST)) return WORDLIST;

  const tip = document.getElementById('wl-tip');
  tip.textContent = '加载 english.txt 中…';

  const resp = await fetch('./english.txt', { cache: 'no-cache' });
  if (!resp.ok) { tip.innerHTML = '<span class="err">无法加载 english.txt</span>'; throw new Error('fetch english.txt failed'); }

  const raw = await resp.text();
  const [rawHash, normHash] = await Promise.all([
    sha256HexOfString(raw),
    sha256HexOfString(normalizeWordlistText(raw)),
  ]);

  if (rawHash !== EXPECTED_WL_SHA256 && normHash !== EXPECTED_WL_SHA256) {
    tip.innerHTML = `<span class="err">english.txt 校验失败！</span><br/>期望：<code>${EXPECTED_WL_SHA256}</code><br/>实际(raw)：<code>${rawHash}</code><br/>实际(norm)：<code>${normHash}</code>`;
    throw new Error('english.txt sha256 mismatch');
  }

  const textOK = (normHash === EXPECTED_WL_SHA256) ? normalizeWordlistText(raw) : raw;
  WORDLIST = textOK.trim().split(/\n/);  // 不再做“2048 行”限制
  WL_READY = true;
  tip.innerHTML = `<span class="ok">english.txt 校验通过（仅首次校验）</span>`;
  return WORDLIST;
}

/* 生成助记词 */
async function generateMnemonic(entBits = 128) {
  if (![128,160,192,224,256].includes(entBits)) throw new Error('strength 仅支持 128/160/192/224/256');
  const wordlist = await ensureWordlist();

  const entropy = new Uint8Array(entBits/8);
  crypto.getRandomValues(entropy);

  const hash = new Uint8Array(await crypto.subtle.digest('SHA-256', entropy));
  const csLen = entBits / 32;
  const bits = bytesToBin(entropy) + bytesToBin(hash).slice(0, csLen);

  const chunks = bits.match(/.{1,11}/g) ?? [];
  const words = chunks.map(b => wordlist[parseInt(b,2)]);

  entropy.fill(0);
  return words.join(' ');
}

/* 助记词 -> Seed */
async function mnemonicToSeed(mnemonic, passphrase=''){
  const mn = mnemonic.normalize('NFKD');
  const salt = ('mnemonic'+passphrase).normalize('NFKD');

  const baseKey = await crypto.subtle.importKey('raw', te.encode(mn), { name:'PBKDF2' }, false, ['deriveBits']);
  const bits = await crypto.subtle.deriveBits(
    { name:'PBKDF2', hash:'SHA-512', salt: te.encode(salt), iterations: 2048 },
    baseKey, 512
  );
  const u8 = new Uint8Array(bits);
  return { seed: u8, seedHex: hex(u8) };
}

/* UI 绑定 */
const $ = id => document.getElementById(id);

$('btn-gen').onclick = async ()=>{
  const tip=$('tip');
  tip.textContent='生成中…';
  $('mnemo').value=''; $('seedhex').value='';

  try{
    const ent = parseInt($('sel-strength').value,10);
    const pass = $('pp').value || '';
    const mn = await generateMnemonic(ent);
    const { seedHex } = await mnemonicToSeed(mn, pass);

    $('mnemo').value = mn;
    $('seedhex').value = seedHex;

    // 正确的词数： (ENT + ENT/32) / 11
    const wordsCount = (ent + ent/32) / 11;
    tip.textContent = `已生成：${wordsCount} 词（${ent}-bit 熵）`;
  }catch(e){
    tip.innerHTML = `<span class="err">失败：${e?.message||e}</span>`;
    console.error(e);
  }
};

$('copy-mn').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('mnemo').value); }catch{} };
$('copy-seed').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('seedhex').value); }catch{} };

/* 页面加载时就预先校验并缓存词表（失败会在 UI 显示原因） */
ensureWordlist().catch(console.error);
</script>
</body>
</html>
