<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>助记词初始化（FIDO2 加密 + 蒙层长按解锁）</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0f1724;--muted:#9ca3af;--text:#e5e7eb;
      --accent:#60a5fa;--good:#10b981;--bad:#ef4444;--line:#1f2937;
    }
    html,body{background:var(--bg);color:var(--text);margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif;}
    .wrap{max-width:980px;margin:32px auto;padding:18px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:18px;margin-bottom:18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .row{display:flex;align-items:center;gap:12px;margin:12px 0}
    .muted{color:var(--muted)}
    button{
      background:linear-gradient(180deg,#0f172a,#091427);border:1px solid rgba(255,255,255,0.06);
      color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer
    }
    button:hover{filter:brightness(1.06)}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .ok{color:var(--good)} .err{color:var(--bad)}
    .small{font-size:13px;color:var(--muted)}

    /* 助记词网格 */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .cell{
      background:linear-gradient(180deg,#071226,#0b1526);
      border:1px dashed rgba(255,255,255,.06);border-radius:12px;padding:10px;
      display:flex;align-items:center;gap:10px;min-height:44px
    }
    .badge{width:26px;height:26px;border-radius:999px;background:#0b1328;display:grid;place-items:center;color:#9fb4d9}

    /* 整块遮挡（覆盖在网格上） */
    .mnemo-box{position:relative}
    .mnemo-mask{
      position:absolute;inset:10px;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(ellipse at center, rgba(15,23,42,.78) 0%, rgba(2,6,23,.9) 100%);
      border:1px dashed #334155;border-radius:14px;backdrop-filter:blur(6px)
    }
    .mask-inner{display:flex;flex-direction:column;align-items:center;gap:10px}
    .hold-btn{
      display:flex;align-items:center;gap:10px;border-radius:999px;padding:12px 16px;
      border:1px solid #1f2a44;background:#0b1328;color:#cfe1ff;cursor:pointer;
      box-shadow:0 8px 22px rgba(0,0,0,.28);user-select:none
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#22d3ee;box-shadow:0 0 0 6px rgba(34,211,238,.15)}
    .hint{text-align:center;color:#9aa4b4}
    .progress{height:4px;background:#1f2a44;width:220px;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#22d3ee}

    @media (max-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>助记词初始化（FIDO2 加密 + 整块遮挡 + 长按 3 秒）</h1>

    <!-- A. FIDO2 凭证 -->
    <div class="card">
      <h3>步骤 A：注册/复用 FIDO2 凭证</h3>
      <div class="row">
        <button id="btn-register">1) 注册或选择本域凭证</button>
        <span id="reg-tip" class="muted"></span>
      </div>
      <div class="small">必须先有凭证；生成时会用该凭证派生 KEK 加密助记词。</div>
    </div>

    <!-- B. 生成 & 展示 -->
    <div class="card">
      <h3>步骤 B：生成助记词（默认整块遮挡；长按 3 秒显示）</h3>
      <div class="row">
        <label><input id="cb-backup" type="checkbox"> 生成并下载离线备份（若选中则不显示助记词，仅下载密文 JSON）</label>
      </div>
      <div class="row">
        <button id="btn-gen" disabled>2) 生成助记词</button>
        <span id="gen-tip" class="muted"></span>
      </div>

      <!-- 助记词卡片：网格 + 整块遮挡 -->
      <div id="mnemo-card" style="display:none;margin-top:10px">
        <div class="mnemo-box" id="mnemo-box">
          <div class="grid" id="mnemo-grid"></div>

          <!-- 蒙层：默认可见；长按 3 秒显示 -->
          <div class="mnemo-mask" id="mnemo-mask">
            <div class="mask-inner">
              <div class="hold-btn" id="hold-btn">
                <span class="dot"></span>
                <span id="hold-text">长按 3 秒显示助记词</span>
              </div>
              <div class="progress"><div class="bar" id="hold-bar"></div></div>
              <div class="hint" id="mask-hint">默认遮挡。2 分钟后会清除内存中的明文，再次解锁需要 FIDO2。</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- C. 加密并写库（原逻辑） -->
    <div class="card">
      <h3>步骤 C：加密 xpub/xprv 并写入数据库</h3>
      <div class="row">
        <button id="btn-encrypt" disabled>3) 加密并写入数据库</button>
        <span id="encrypt-tip" class="muted"></span>
      </div>
      <div class="small">bundle 不包含助记词明文。</div>
    </div>

    <div class="small" id="final"></div>
  </div>

<script type="module">
/* ===== 依赖：与你现有 fido2.js / hdwallet-core.js 对齐 ===== */
import {
  ensureCredentialWithChoice,
  deriveKEK,
  deriveKEKWithSalt,
  aesGcmEncryptStr,
  aesGcmDecryptStr,
  loadCredHex,
} from './js/fido2.js';

import {
  genMnemonic, mnemonicToSeed, exportBranches,
} from './js/hdwallet-core.js';

/* ===== 常量与状态 ===== */
const API_BASE = 'https://wallet.lucas-l-shang.workers.dev';

const GRACE_MS   = 120_000;      // “首次显示后”2 分钟窗口
const HOLD_MS    = 3_000;        // 蒙层长按 3 秒

let branches = null;             // 各链分支（用于写库）
let sealed   = null;             // { ctHex, ivHex, saltHex, credId }
let plainMnemonic = '';          // 明文助记词（仅在窗口期保存）
let wordCount   = 12;

let graceTimer  = null;          // 2 分钟窗口计时器
let graceStarted = false;        // 是否已经启动过窗口（只启动一次）

/* ===== DOM 快捷 ===== */
const $ = (id)=>document.getElementById(id);

/* ===== 工具：渲染网格 & 遮挡控制 ===== */
function renderGrid(words){
  const grid = $('mnemo-grid'); if (!grid) return;
  grid.innerHTML='';
  words.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='cell';
    d.innerHTML = `<span class="badge">${i+1}</span><span class="word">${w}</span>`;
    grid.appendChild(d);
  });
}
function renderMaskedGrid(n){ renderGrid(Array.from({length:n},()=> '•••••')); }

function showCard(){ const c=$('mnemo-card'); if(c)c.style.display='block'; }
function showMask(){ const m=$('mnemo-mask'); if(m)m.style.display='flex'; }
function hideMask(){ const m=$('mnemo-mask'); if(m)m.style.display='none'; }

function clearGraceTimer(){ if(graceTimer){ clearTimeout(graceTimer); graceTimer=null; } }

/* ===== 按钮状态 ===== */
function enableGen(on=true){ const b=$('btn-gen'); if(b) b.disabled=!on; }
function enableEncrypt(on=true){ const b=$('btn-encrypt'); if(b) b.disabled=!on; }

/* ===== 初始化：若已有凭证，允许生成 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    if(loadCredHex()){
      enableGen(true);
      const tip=$('reg-tip'); if(tip) tip.innerHTML='<span class="ok">已可使用凭证（本地已存在）。</span>';
    }
  }catch{}
});

/* ===== A. 注册/复用 FIDO2 ===== */
$('btn-register').onclick = async ()=>{
  const tip=$('reg-tip');
  try{
    const res=await ensureCredentialWithChoice();
    if(tip){
      tip.innerHTML = res?.created
        ? '<span class="ok">已注册新凭证。</span>'
        : `<span class="ok">已可使用凭证（id: ${(res?.id_hex||'').slice(0,16)}…）。</span>`;
    }
    enableGen(true);
  }catch(e){
    if(tip) tip.innerHTML=`<span class="err">注册/复用失败：${e?.message||e}</span>`;
    console.error(e);
  }
};

/* ===== B. 生成助记词（默认整块遮挡；“首次显示后”才启动 2 分钟窗口） ===== */
$('btn-gen').onclick = async ()=>{
  const tip=$('gen-tip');
  try{
    // 1) 生成助记词 + 分支
    const mnemonic = genMnemonic(128);
    const words    = mnemonic.trim().split(/\s+/);
    wordCount      = words.length || 12;
    const seed     = mnemonicToSeed(mnemonic,'');
    branches       = exportBranches(seed);
    enableEncrypt(true);

    // 2) 立刻用 FIDO2 派生 KEK 加密（sealed）；但此时“窗口尚未启动”
    const { kek, salt, rp_id, info, credential_id, toHex } = await deriveKEK();
    const enc = await aesGcmEncryptStr(kek, mnemonic);
    sealed = { ctHex: enc.ciphertext, ivHex: enc.nonce, saltHex: toHex(salt), credId: credential_id, rp_id, info };

    // 3) 明文先留在内存（等待用户第一次解锁后再启动 2 分钟窗口）
    plainMnemonic = mnemonic;
    graceStarted  = false;
    clearGraceTimer();

    // 4) UI：显示卡片 + 整块遮挡（首次默认遮挡）
    showCard();
    renderMaskedGrid(wordCount);
    showMask();
    $('hold-text').textContent = '长按 3 秒显示助记词';
    $('mask-hint').textContent = '默认遮挡。第一次显示后将开始 2 分钟窗口，到点会自动遮挡并清空明文。';
    tip.textContent='';

    // 5) 安全擦除局部 words 数组副本（尽量减少可被抓取的字符串副本）
    try{ for(let i=0;i<words.length;i++) words[i]=''; }catch{}
  }catch(e){
    if(tip) tip.innerHTML=`<span class="err">生成失败：${e?.message||e}</span>`;
    console.error(e);
  }
};

/* ===== B. 蒙层长按 3 秒：显示助记词 =====
   - 若 plainMnemonic 存在：直接显示；若这是“首次显示”，此刻启动 2 分钟窗口；
   - 若 plainMnemonic 不在：走 FIDO2 解密后显示（不再开启窗口）。 */
(function bindHoldToReveal(){
  const btn = $('hold-btn'), bar = $('hold-bar'), text=$('hold-text');
  if(!btn||!bar) return;

  let pressing=false, t0=0, rafId=0, timerId=0;

  const start = ()=>{
    if(pressing) return;
    pressing=true; t0=performance.now();
    bar.style.width='0%';

    const step = ()=>{
      if(!pressing) return;
      const p = Math.min(1, (performance.now()-t0)/HOLD_MS);
      bar.style.width = (p*100).toFixed(1)+'%';
      if(p>=1){ done(); return; }
      rafId = requestAnimationFrame(step);
    };
    rafId = requestAnimationFrame(step);
    timerId = setTimeout(done, HOLD_MS);
  };

  const cancel = ()=>{
    pressing=false;
    if(rafId) cancelAnimationFrame(rafId);
    if(timerId) clearTimeout(timerId);
    bar.style.width='0%';
  };

  const startGraceIfFirstReveal = ()=>{
    if(!graceStarted){
      graceStarted = true;
      clearGraceTimer();
      graceTimer = setTimeout(()=>{
        // 到点：遮挡 + 清空明文
        plainMnemonic = '';
        renderMaskedGrid(wordCount);
        showMask();
        const hint = $('mask-hint');
        if(hint) hint.textContent = '2 分钟窗口已结束。再次显示需要 FIDO2。';
      }, GRACE_MS);
    }
  };

  const done = async ()=>{
    cancel();
    try{
      let mnemonic;
      if(plainMnemonic){
        // 窗口内（或首次显示之前）：不用 FIDO2
        mnemonic = plainMnemonic;
        startGraceIfFirstReveal();   // 首次显示时启动窗口
      }else{
        // 需要 FIDO2 解密
        const { kek } = await deriveKEKWithSalt(sealed.saltHex, sealed.credId);
        mnemonic = await aesGcmDecryptStr(kek, sealed.ivHex, sealed.ctHex);
        // 出于更严格策略：FIDO2 解密后的显示，不再开启新的窗口
      }

      const words = mnemonic.trim().split(/\s+/);
      renderGrid(words);
      hideMask();

      // 不再做 30 秒自动遮挡；由 2 分钟窗口结束时统一遮挡 & 清明文
      try{ for(let i=0;i<words.length;i++) words[i]=''; }catch{}
    }catch(e){
      console.error(e);
      text.textContent='解锁失败：请重试';
      setTimeout(()=>{ text.textContent='长按 3 秒显示助记词'; }, 1500);
    }
  };

  // 鼠标/触摸都支持长按
  ['mousedown','touchstart'].forEach(ev=>btn.addEventListener(ev, start));
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev, cancel));
})();

/* ===== C. 加密并写库（保持原逻辑） ===== */
$('btn-encrypt').onclick = async ()=>{
  const tip=$('encrypt-tip');
  try{
    if(!branches){ alert('请先生成助记词'); return; }
    tip.textContent='请触摸密钥以继续…';

    const { kek, salt, rp_id, info, credential_id, toHex } = await deriveKEK();
    const enc = async s => s ? await aesGcmEncryptStr(kek, s) : null;
    const bundle = {
      KEKInfo:{ rp_id, info, salt: toHex(salt), credential_id },
      chains:{
        ETH:  { path: branches.ETH.path,  PubEnc: await enc(branches.ETH.xpub),   PrivEnc: await enc(branches.ETH.xprv) },
        BTC:  { path: branches.BTC.path,  PubEnc: await enc(branches.BTC.xpub_z), PrivEnc: await enc(branches.BTC.xprv_z) },
        EOS:  { path: branches.EOS.path,  PubEnc: await enc(branches.EOS.xpub),   PrivEnc: await enc(branches.EOS.xprv) },
        TRON: { path: branches.TRON.path, PubEnc: await enc(branches.TRON.xpub),  PrivEnc: await enc(branches.TRON.xprv) },
      }
    };

    const resp = await fetch(`${API_BASE}/bundles`, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ user_id:'web-ui', note:'初始化保存（UI）', bundle })
    });
    const data = await resp.json().catch(()=> ({}));
    if(!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

    tip.textContent='';
    // 清理最敏感的私钥副本
    branches.ETH.xprv = branches.EOS.xprv = branches.TRON.xprv = null;
    branches.BTC.xprv_z = null;
    alert(`写入成功：bundle_id=${data.bundle_id}`);
  }catch(e){
    tip.textContent='';
    alert('写入失败：'+(e?.message||e));
    console.error(e);
  }
};
</script>

</body>
</html>
