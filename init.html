<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>åŠ©è®°è¯åˆå§‹åŒ–ï¼ˆFIDO2 åŠ å¯† + æ•´å—é®æŒ¡ + å•å‡»æ˜¾ç¤ºï¼‰</title>
<style>
  :root{--bg:#0b1220;--card:#0f1724;--muted:#9ca3af;--text:#e5e7eb;--accent:#60a5fa;--good:#10b981;--bad:#ef4444;--line:#1f2937}
  html,body{background:var(--bg);color:var(--text);margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}
  .wrap{max-width:980px;margin:32px auto;padding:18px}
  h1{margin:0 0 12px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:18px;margin-bottom:18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .row{display:flex;align-items:center;gap:12px;margin:12px 0}
  .muted{color:var(--muted)}
  button{background:linear-gradient(180deg,#0f172a,#091427);border:1px solid rgba(255,255,255,.06);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
  button:hover{filter:brightness(1.06)} button[disabled]{opacity:.45;cursor:not-allowed}
  .ok{color:var(--good)} .err{color:var(--bad)}
  .small{font-size:13px;color:var(--muted)}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .cell{background:linear-gradient(180deg,#071226,#0b1526);border:1px dashed rgba(255,255,255,.06);border-radius:12px;padding:10px;display:flex;align-items:center;gap:10px;min-height:44px}
  .badge{width:26px;height:26px;border-radius:999px;background:#0b1328;display:grid;place-items:center;color:#9fb4d9}
  .mnemo-box{position:relative}
  .mnemo-mask{position:absolute;inset:10px;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center, rgba(15,23,42,.78) 0%, rgba(2,6,23,.9) 100%);border:1px dashed #334155;border-radius:14px;backdrop-filter:blur(6px)}
  .mask-inner{display:flex;flex-direction:column;align-items:center;gap:10px}
  .reveal-btn{display:flex;align-items:center;gap:10px;border-radius:999px;padding:12px 16px;border:1px solid #1f2a44;background:#0b1328;color:#cfe1ff;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.28);user-select:none}
  .hint{text-align:center;color:#9aa4b4}
  @media (max-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
<div class="wrap">
  <h1>åŠ©è®°è¯åˆå§‹åŒ–ï¼ˆFIDO2 åŠ å¯† + æ•´å—é®æŒ¡ + å•å‡»æ˜¾ç¤º 60sï¼‰</h1>

  <!-- A. FIDO2 å‡­è¯ -->
  <div class="card">
    <h3>æ­¥éª¤ Aï¼šæ³¨å†Œ/é€‰æ‹©æœ¬åŸŸ FIDO2 å‡­è¯</h3>
    <div class="row">
      <button id="btn-register">1) æ³¨å†Œæˆ–é€‰æ‹©å‡­è¯</button>
      <span id="reg-tip" class="muted"></span>
    </div>
    <div class="small">åç»­æ­¥éª¤å°†å¼ºåˆ¶ä½¿ç”¨åŒä¸€æŠŠå‡­è¯ï¼ˆé˜²æ­¢ A æ­¥éª¤é€‰ Aï¼ŒB æ­¥éª¤å´è§¦æ‘¸äº† Bï¼‰ã€‚</div>
  </div>

  <!-- B. ç”Ÿæˆ + æ•´å—é®æŒ¡ + å•å‡»è§£é”æ˜¾ç¤º -->
  <div class="card">
    <h3>æ­¥éª¤ Bï¼šç”ŸæˆåŠ©è®°è¯ï¼ˆç”Ÿæˆå³åŠ å¯†ï¼›é»˜è®¤æ•´å—é®æŒ¡ï¼‰</h3>
    <div class="row">
      <button id="btn-gen" disabled>2) ç”ŸæˆåŠ©è®°è¯</button>
      <span id="gen-tip" class="muted"></span>
    </div>

    <div id="mnemo-card" style="display:none;margin-top:10px">
      <div class="mnemo-box" id="mnemo-box">
        <div class="grid" id="mnemo-grid"></div>
        <div class="mnemo-mask" id="mnemo-mask">
          <div class="mask-inner">
            <button class="reveal-btn" id="reveal-btn">ç‚¹å‡»æ˜¾ç¤ºåŠ©è®°è¯ï¼ˆ60 ç§’ï¼‰</button>
            <div class="hint" id="mask-hint">å·²ç”¨ FIDO2 åŠ å¯†ï¼Œé¡µé¢ä»…ä¿å­˜å¯†æ–‡ã€‚ç‚¹å‡»éœ€è¦è§¦æ‘¸åŒä¸€æŠŠé’¥åŒ™è§£å¯†ã€‚</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- C. åŠ å¯† xprv å¹¶å†™åº“ -->
  <div class="card">
    <h3>æ­¥éª¤ Cï¼šåŠ å¯† xprv å¹¶å†™å…¥æ•°æ®åº“</h3>
    <div class="row">
      <button id="btn-encrypt" disabled>3) å†™å…¥æ•°æ®åº“</button>
      <span id="encrypt-tip" class="muted"></span>
    </div>
    <div class="small">bundle ä¸åŒ…å«åŠ©è®°è¯æ˜æ–‡ï¼›å„é“¾ xprv å·²åœ¨æ­¥éª¤ B ç”Ÿæˆæ—¶åŠ å¯†ã€‚</div>
  </div>

  <div class="small" id="final"></div>
</div>

<script type="module">
import {
  ensureCredentialWithChoice,
  deriveKEKWithNewSaltForCred,
  deriveKEKWithSalt,
  aesGcmEncryptStr,
  aesGcmDecryptStr,
  loadCredHex,
} from './js/fido2.js';

import { genMnemonic, mnemonicToSeed, exportBranches } from './js/hdwallet-core.js';

/* é…ç½® */
const API_BASE   = 'https://wallet.lucas-l-shang.workers.dev';
const SHOW_MS    = 60_000;  // æ¯æ¬¡æ˜¾ç¤º 60 ç§’

/* çŠ¶æ€ */
let selectedCredHex = null;  // æ­¥éª¤ A é€‰ä¸­çš„â€œå”¯ä¸€â€å‡­è¯
let sealed = null;           // åŠ©è®°è¯å¯†æ–‡ { saltHex, ivHex, ctHex, credId, rp_id, info }
let encXprv = null;          // å„é“¾ xprv çš„å¯†æ–‡ { chain: { nonce, ciphertext }, ... }
let xpubs  = null;           // å„é“¾ xpubï¼ˆæ˜æ–‡ï¼Œç”¨äºå†™åº“ï¼‰
let paths  = null;           // å„é“¾ pathï¼ˆå†™åº“ç”¨ï¼‰
let autoMaskTimer = null;

/* DOM */
const $ = id => document.getElementById(id);
function renderMaskedGrid(n=12){
  const grid=$('mnemo-grid'); grid.innerHTML='';
  for(let i=0;i<n;i++){
    const d=document.createElement('div'); d.className='cell';
    d.innerHTML=`<span class="badge">${i+1}</span><span>â€¢â€¢â€¢â€¢â€¢</span>`;
    grid.appendChild(d);
  }
}
function showMask(){ $('mnemo-mask').style.display='flex'; }
function hideMask(){ $('mnemo-mask').style.display='none'; }
function resetAutoMask(){ if(autoMaskTimer){ clearTimeout(autoMaskTimer); autoMaskTimer=null; } }

async function queryBundlesByCred(credHex) {
  const resp = await fetch(`${API_BASE}/bundles/by-cred/${credHex}`, { method: 'GET' });
  const data = await resp.json().catch(()=> ({}));
  if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
  return data; // { ok:true, count, items: [...] }
}

/* æ­¥éª¤ Aï¼šé€‰æ‹©/æ³¨å†Œå‡­è¯ï¼ˆå¹¶é”å®šï¼‰ */
$('btn-register').onclick = async ()=>{
  const tip=$('reg-tip');
  try{
    const res = await ensureCredentialWithChoice();  // { ok, id_hex, created }
    const credHex = res?.id_hex;

    if (tip) {
      tip.innerHTML = res?.created
        ? '<span class="ok">å·²æ³¨å†Œæ–°å‡­è¯ã€‚</span>'
        : `<span class="ok">å·²å¯ä½¿ç”¨å‡­è¯ï¼ˆid: ${(credHex||'').slice(0,16)}â€¦ï¼‰ã€‚</span>`;
    }
    $('btn-gen').disabled = false;

    // ğŸ” æ–°å¢ï¼šæ£€æŸ¥ DB æ˜¯å¦å·²æœ‰æ­¤ credential çš„æ•°æ®
    if (credHex) {
      try {
        const q = await queryBundlesByCred(credHex);
        if (q.count > 0) {
          // ä½ å¯ä»¥æ¢æˆè‡ªå®šä¹‰å¼¹çª—ï¼Œè¿™é‡Œå…ˆç”¨ confirm
          const latest = q.items[0]; // æœ€è¿‘ä¸€æ¡
          const ts = latest?.created_at ? new Date(latest.created_at * 1000).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
          const msg = [
            `æ£€æµ‹åˆ°è¿™æŠŠå‡­è¯åœ¨æ•°æ®åº“ä¸­å·²æœ‰ ${q.count} æ¡è®°å½•ã€‚`,
            `æœ€è¿‘ä¸€æ¬¡ï¼šbundle_id=${latest?.bundle_id || '(æ— )'}ï¼Œæ—¶é—´=${ts}ã€‚`,
            '',
            'æ˜¯å¦ç»§ç»­å¤ç”¨è¯¥å‡­è¯ï¼Ÿï¼ˆç»§ç»­ = ç”Ÿæˆæ–°æ•°æ®ï¼›å–æ¶ˆ = å…ˆå»æ ¸å¯¹å†å²ï¼‰'
          ].join('\n');
          const goOn = confirm(msg);
          if (!goOn) {
            // ç”¨æˆ·å–æ¶ˆï¼šä½ ä¹Ÿå¯ä»¥åœ¨æ­¤å¼•å¯¼ä¸€ä¸ªâ€œæŸ¥çœ‹å†å²â€çš„é“¾æ¥
            // ä¾‹å¦‚ï¼šlocation.href = '/history.html?cred=' + encodeURIComponent(credHex);
            return;
          }
        }
      } catch (e) {
        // æŸ¥è¯¢å¤±è´¥ä¸é˜»å¡ä¸»æµç¨‹ï¼Œåªå†™æ—¥å¿—
        console.warn('query by credential failed:', e);
      }
    }
  }catch(e){
    if(tip) tip.innerHTML=`<span class="err">æ³¨å†Œ/å¤ç”¨å¤±è´¥ï¼š${e?.message||e}</span>`;
    console.error(e);
  }
};

/* æ­¥éª¤ Bï¼šç”Ÿæˆï¼ˆç”¨â€œæ­¥éª¤AåŒä¸€æŠŠâ€+éšæœº salt æ´¾ç”Ÿ KEKï¼‰â†’ ç«‹åˆ»å…¨åŠ å¯† â†’ æ¸…æ˜æ–‡ */
$('btn-gen').onclick = async ()=>{
  const tip=$('gen-tip');
  try{
    if(!selectedCredHex) { tip.innerHTML='<span class="err">è¯·å…ˆå®Œæˆæ­¥éª¤ Aã€‚</span>'; return; }

    // 1) ç”ŸæˆåŠ©è®°è¯ & åˆ†æ”¯
    const mnemonic = genMnemonic(128);
    const seed     = mnemonicToSeed(mnemonic,'');
    const branches = exportBranches(seed);  // {ETH,BTC,EOS,TRON}

    // 2) ç”¨â€œæ­¥éª¤AåŒä¸€æŠŠâ€+éšæœº salt æ´¾ç”Ÿ KEKï¼ˆå¦‚æœç”¨æˆ·è§¦æ‘¸äº†å¦ä¸€æŠŠï¼Œä¼šæŠ¥ NotAllowedï¼‰
    const { kek, salt, rp_id, info, credential_id, toHex } =
      await deriveKEKWithNewSaltForCred(selectedCredHex);

    // 3) åŠ å¯†åŠ©è®°è¯
    const encM = await aesGcmEncryptStr(kek, mnemonic);
    sealed = { saltHex: toHex(salt), ivHex: encM.nonce, ctHex: encM.ciphertext, credId: credential_id, rp_id, info };

    // 4) åŠ å¯†å„é“¾ xprvï¼ˆxpub æ˜æ–‡ä¿ç•™ï¼‰
    encXprv = {};
    xpubs   = {};
    paths   = {};
    // ETH
    encXprv.ETH = await aesGcmEncryptStr(kek, branches.ETH.xprv);
    xpubs.ETH   = branches.ETH.xpub;
    paths.ETH   = branches.ETH.path;
    // BTCï¼ˆä½ ä¹‹å‰å¯¼å‡ºçš„æ˜¯ z* ç‰ˆæœ¬ xprv/xpubï¼‰
    encXprv.BTC = await aesGcmEncryptStr(kek, branches.BTC.xprv_z);
    xpubs.BTC   = branches.BTC.xpub_z;
    paths.BTC   = branches.BTC.path;
    // EOS
    encXprv.EOS = await aesGcmEncryptStr(kek, branches.EOS.xprv);
    xpubs.EOS   = branches.EOS.xpub;
    paths.EOS   = branches.EOS.path;
    // TRON
    encXprv.TRON = await aesGcmEncryptStr(kek, branches.TRON.xprv);
    xpubs.TRON   = branches.TRON.xpub;
    paths.TRON   = branches.TRON.path;

    // 5) ç«‹å³æ¸…ç†æ˜æ–‡
    try{
      for (const k of ['ETH','BTC','EOS','TRON']) {
        if (branches[k]) { branches[k].xprv = branches[k].xprv_z = null; }
      }
    }catch{}
    // è¦†ç›–å˜é‡
    // eslint-disable-next-line no-unused-vars
    // (seed, mnemonic) å‡ä¸å†ä¿ç•™
    // 6) UIï¼šæ˜¾ç¤ºå¡ç‰‡ï¼ˆé»˜è®¤é®æŒ¡ï¼‰ï¼Œç”¨æˆ·ç‚¹å‡»é®æŒ¡æŒ‰é’®æ—¶å†è§£å¯†æ˜¾ç¤º 60s
    $('mnemo-card').style.display='block';
    renderMaskedGrid(12);
    showMask();
    tip.innerHTML = '<span class="ok">å·²ç”Ÿæˆå¹¶åŠ å¯†ï¼ˆé»˜è®¤é®æŒ¡ï¼‰ã€‚</span>';
    $('btn-encrypt').disabled = false;
  }catch(e){
    // è¿™é‡Œæœ€å¸¸è§çš„æ˜¯ NotAllowedErrorï¼šæ¯”å¦‚ç”¨æˆ·è§¦æ‘¸äº†ä¸æ­¥éª¤Aä¸åŒçš„é’¥åŒ™
    tip.innerHTML = `<span class="err">ç”Ÿæˆå¤±è´¥ï¼š${e?.message||e}ï¼ˆè¯·ç¡®ä¿ä½¿ç”¨æ­¥éª¤ A é€‰æ‹©çš„åŒä¸€æŠŠé’¥åŒ™ï¼‰</span>`;
    console.error(e);
  }
};

/* å•å‡»è§£é”æ˜¾ç¤º 60 ç§’ï¼ˆå¼ºåˆ¶åŒä¸€æŠŠé’¥åŒ™ + sealed.saltHexï¼‰ */
$('reveal-btn').onclick = async ()=>{
  try{
    if (!sealed || !selectedCredHex) return;
    resetAutoMask();

    // ç”¨â€œæ­¥éª¤ A çš„ selectedCredHex + sealed.saltHexâ€æ´¾ç”Ÿ KEKï¼Œå†è§£å¯†åŠ©è®°è¯
    const { kek } = await deriveKEKWithSalt(selectedCredHex, sealed.saltHex);
    const mnemonic = await aesGcmDecryptStr(kek, { nonce: sealed.ivHex, ciphertext: sealed.ctHex });

    // æ¸²æŸ“æ˜æ–‡
    const words = mnemonic.trim().split(/\s+/);
    const grid=$('mnemo-grid'); grid.innerHTML='';
    words.forEach((w,i)=>{
      const d=document.createElement('div'); d.className='cell';
      d.innerHTML=`<span class="badge">${i+1}</span><span>${w}</span>`;
      grid.appendChild(d);
    });
    hideMask();

    // 60 ç§’åè‡ªåŠ¨é®æŒ¡å¹¶æ¸…ç†æ˜æ–‡å‰¯æœ¬
    autoMaskTimer = setTimeout(()=>{
      renderMaskedGrid(words.length);
      showMask();
      // è¿™é‡Œä¸å†ä¿ç•™æ˜æ–‡å˜é‡
    }, SHOW_MS);
  }catch(e){
    $('mask-hint').textContent = 'è§£é”å¤±è´¥ï¼šè¯·ç¡®è®¤ä½¿ç”¨æ­¥éª¤ A çš„åŒä¸€æŠŠé’¥åŒ™';
    setTimeout(()=>{ $('mask-hint').textContent='å·²ç”¨ FIDO2 åŠ å¯†ï¼Œé¡µé¢ä»…ä¿å­˜å¯†æ–‡ã€‚ç‚¹å‡»éœ€è¦è§¦æ‘¸åŒä¸€æŠŠé’¥åŒ™è§£å¯†ã€‚'; }, 2000);
    console.error(e);
  }
};

/* æ­¥éª¤ Cï¼šç›´æ¥å†™åº“ï¼ˆä½¿ç”¨ encXprv + xpubs + sealed çš„ KEKInfoï¼‰ */
$('btn-encrypt').onclick = async ()=>{
  const tip=$('encrypt-tip');
  try{
    if (!sealed || !encXprv || !xpubs || !paths) {
      tip.innerHTML='<span class="err">è¯·å…ˆå®Œæˆæ­¥éª¤ Bã€‚</span>';
      return;
    }
    if (!selectedCredHex) {
      tip.innerHTML='<span class="err">è¯·å…ˆå®Œæˆæ­¥éª¤ Aï¼ˆé€‰æ‹©/æ³¨å†Œå‡­è¯ï¼‰ã€‚</span>';
      return;
    }

    // 1) å…ˆåšä¸€æ¬¡ WebAuthn PRFï¼šå¼ºåˆ¶â€œåŒä¸€æŠŠé’¥åŒ™â€
    tip.textContent = 'è¯·è§¦æ‘¸åŒä¸€æŠŠ FIDO2 å®‰å…¨é’¥åŒ™ä»¥ç¡®è®¤â€¦';
    // è¿™é‡Œä¸å¤ç”¨è¿”å›çš„ keyï¼Œä»…ä½œä¸ºâ€œåŒä¸€æŠŠâ€æ ¡éªŒï¼›ä¸åŒé’¥åŒ™å°†æŠ› NotAllowedError/InvalidStateError
    await deriveKEKWithSalt(selectedCredHex, sealed.saltHex);

    // 2) æ ¡éªŒé€šè¿‡æ‰çœŸæ­£å†™åº“
    tip.textContent = 'å†™å…¥ä¸­â€¦';
    const body = {
      user_id: 'web-ui',
      note   : 'bundle-init',
      bundle : {
        KEKInfo: {
          rp_id: sealed.rp_id, info: sealed.info,
          salt: sealed.saltHex, credential_id: sealed.credId
        },
        chains: {
          ETH:  { path: paths.ETH,  PubEnc: null,            PrivEnc: encXprv.ETH  },
          BTC:  { path: paths.BTC,  PubEnc: null,            PrivEnc: encXprv.BTC  },
          EOS:  { path: paths.EOS,  PubEnc: null,            PrivEnc: encXprv.EOS  },
          TRON: { path: paths.TRON, PubEnc: null,            PrivEnc: encXprv.TRON },
        }
      }
    };

    const resp = await fetch(`${API_BASE}/bundles`, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(()=> ({}));
    if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

    tip.textContent='';
    $('final').innerHTML = `<span class="ok">å†™å…¥æˆåŠŸï¼šbundle_id=${data.bundle_id}</span>`;
  }catch(e){
    tip.textContent='';
    // å¸¸è§ï¼šNotAllowedError/InvalidStateError = ä¸æ˜¯åŒä¸€æŠŠé’¥åŒ™ æˆ– å–æ¶ˆ/è¶…æ—¶
    $('final').innerHTML = `<span class="err">å†™å…¥å¤±è´¥ï¼š${e?.name||''} ${e?.message||e}</span>`;
    console.error(e);
  }
};
</script>
</body>
</html>
