<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>åŠ©è®°è¯åˆå§‹åŒ– + FIDO2 åŠ å¯†å†™åº“</title>
<style>
  body {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,PingFang SC,"Microsoft YaHei",sans-serif;
    background: #f9fafb;
    margin: 40px auto;
    max-width: 720px;
    padding: 0 16px;
    color: #111827;
  }
  h2 {
    margin-bottom: 8px;
  }
  ol {
    background: #fff;
    border-radius: 12px;
    padding: 16px 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  button {
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    background: #111827;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
    transition: background .2s;
  }
  button:hover:not(:disabled){ background:#1f2937 }
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type="password"]{
    padding:8px;
    border-radius:8px;
    border:1px solid #cbd5e1;
    width:100%;
  }
  .row{margin:18px 0}
  .muted{color:#6b7280}
  .grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin-top:8px;
  }
  .cell{
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:10px 12px;
    background:#fafafa;
    text-align:center;
    font-size:15px;
    box-shadow:inset 0 1px 2px rgba(0,0,0,0.05);
  }
  .badge{
    display:inline-block;
    background:#111827;
    color:#fff;
    border-radius:999px;
    padding:2px 8px;
    margin-right:6px;
    font-size:12px;
  }
  .ok{color:#059669}
  .err{color:#b91c1c}

  /* åŠ©è®°è¯é®ç½©å±‚ */
  .mnemo-mask{
    position:relative;
    background:#f3f4f6;
    border:2px dashed #d1d5db;
    border-radius:12px;
    padding:40px 0;
    text-align:center;
    color:#9ca3af;
    font-size:15px;
  }
  .eye-btn{
    background:none;
    border:none;
    cursor:pointer;
    font-size:24px;
    color:#6b7280;
    transition:color .2s;
  }
  .eye-btn:hover{color:#111827}
</style>
</head>

<body>
  <h2>åˆå§‹åŒ–æµç¨‹</h2>
  <ol>
    <li>ç”ŸæˆåŠ©è®°è¯ï¼ˆé»˜è®¤<b>éšè—æ˜¾ç¤º</b>ï¼Œå¯ç‚¹å‡»æŸ¥çœ‹ 1 åˆ†é’Ÿï¼‰å¹¶åœ¨å†…å­˜ä¸­å¯¼å‡ºå„é“¾åˆ†æ”¯ã€‚</li>
    <li>ï¼ˆå¯é€‰ï¼‰è¾“å…¥å¯†ç ç”Ÿæˆ<b>ç¦»çº¿åŠ å¯†å¤‡ä»½</b>ï¼ˆPBKDF2+AES-GCMï¼‰ã€‚</li>
    <li>æ³¨å†Œ/å¤ç”¨ FIDO2 å‡­è¯ã€‚</li>
    <li>ä½¿ç”¨å‡­è¯æ´¾ç”Ÿ KEK â†’ åŠ å¯†åˆ†æ”¯ â†’ å†™å…¥æ•°æ®åº“ã€‚</li>
  </ol>

  <!-- Step 1 -->
  <div class="row">
    <button id="btn-gen">â‘  ç”ŸæˆåŠ©è®°è¯</button>
    <span id="gen-tip" class="muted">æœªç”Ÿæˆ</span>
  </div>

  <div id="mnemo-wrap" class="row" style="display:none">
    <div id="mnemo-mask" class="mnemo-mask">
      <p>åŠ©è®°è¯å·²ç”Ÿæˆï¼Œç‚¹å‡»ä¸‹æ–¹ ğŸ‘ï¸ æŸ¥çœ‹ï¼ˆæ˜¾ç¤º 60 ç§’åè‡ªåŠ¨éšè—ï¼‰</p>
      <button id="btn-show" class="eye-btn" title="ç‚¹å‡»æŸ¥çœ‹åŠ©è®°è¯">ğŸ‘ï¸</button>
    </div>
    <div class="grid" id="mnemo-grid" style="display:none"></div>
    <div class="muted">è¯·ç«‹å³æŠ„å†™ä¿å­˜ã€‚é¡µé¢ä¸ä¼šæ°¸ä¹…ä¿ç•™åŠ©è®°è¯ï¼›ç§é’¥ä¸ä¼šæ˜¾ç¤ºã€‚</div>
  </div>

  <!-- Step 2 -->
  <div class="row">
    <label><input id="want-backup" type="checkbox"> ç”Ÿæˆ<b>ç¦»çº¿åŠ å¯†å¤‡ä»½</b>ï¼ˆJSON æ–‡ä»¶ï¼‰</label>
  </div>
  <div id="backup-area" class="row" style="display:none">
    <div class="muted">å¯†ç éœ€ â‰¥8 ä¸”åŒ…å«å­—æ¯+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ã€‚</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="pw1" type="password" placeholder="å¤‡ä»½å¯†ç ">
      <input id="pw2" type="password" placeholder="å†æ¬¡è¾“å…¥">
      <button id="btn-backup" disabled>ç”Ÿæˆå¹¶ä¸‹è½½</button>
    </div>
    <div id="pw-tip" class="muted"></div>
  </div>

  <!-- Step 3 -->
  <div class="row">
    <button id="btn-register">â‘¡ æ³¨å†Œ/å¤ç”¨ FIDO2 å‡­è¯</button>
    <span id="reg-tip" class="muted"></span>
  </div>

  <!-- Step 4 -->
  <div class="row">
    <button id="btn-encrypt" disabled>â‘¢ åŠ å¯†åˆ†æ”¯å¹¶å†™å…¥æ•°æ®åº“</button>
    <span id="encrypt-tip" class="muted"></span>
  </div>

  <div id="final-tip" class="row muted"></div>

  <script type="module">
    import {
      genMnemonic, splitWords, mnemonicToSeed, exportBranches,
      createPasswordBackupBlob, validatePasswordStrict
    } from './js/hdwallet-core.js';

    import {
      registerCredentialIfNeeded,
      deriveKEK, aesGcmEncryptStr
    } from './js/fido2.js';

    const $ = id => document.getElementById(id);
    let mnemonic = null;
    let branches = null;
    let hideTimer = null;

    function renderMnemonicOnce(m){
      const words = splitWords(m);
      const grid = $('mnemo-grid'); grid.innerHTML = '';
      words.forEach((w,i)=>{
        const d = document.createElement('div'); d.className='cell';
        d.innerHTML = `<span class="badge">${i+1}</span>${w}`;
        grid.appendChild(d);
      });
      $('mnemo-wrap').style.display = 'block';
      $('mnemo-mask').style.display = 'block';
      $('mnemo-grid').style.display = 'none';
    }

    // åŠ©è®°è¯æ˜¾ç¤ºä¸éšè—é€»è¾‘
    function showMnemonicTemporarily(){
      $('mnemo-mask').style.display = 'none';
      $('mnemo-grid').style.display = 'grid';
      if (hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>{
        $('mnemo-grid').style.display = 'none';
        $('mnemo-mask').style.display = 'block';
      }, 60000); // 60 ç§’åè‡ªåŠ¨éšè—
    }

    $('btn-show').onclick = showMnemonicTemporarily;

    $('btn-gen').onclick = ()=>{
      mnemonic = genMnemonic(128);
      renderMnemonicOnce(mnemonic);
      const seed = mnemonicToSeed(mnemonic, '');
      branches = exportBranches(seed);
      $('gen-tip').textContent = 'åŠ©è®°è¯å·²ç”Ÿæˆï¼ˆé»˜è®¤éšè—ï¼‰ï¼Œåˆ†æ”¯å·²å¯¼å‡ºã€‚';
      $('btn-encrypt').disabled = false;
      $('final-tip').textContent = '';
    };

    $('want-backup').onchange = e=>{
      $('backup-area').style.display = e.target.checked ? 'block' : 'none';
      $('btn-backup').disabled = !e.target.checked;
    };
    $('pw1').oninput = $('pw2').oninput = ()=>{
      const p1=$('pw1').value, p2=$('pw2').value;
      if (!p1 && !p2){ $('pw-tip').textContent=''; $('btn-backup').disabled=true; return; }
      if (p1!==p2){ $('pw-tip').innerHTML='<span class="err">ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´</span>'; $('btn-backup').disabled=true; return; }
      const v = validatePasswordStrict(p1);
      if (!v.ok){ $('pw-tip').innerHTML='<span class="err">'+v.reason+'</span>'; $('btn-backup').disabled=true; return; }
      $('pw-tip').innerHTML='<span class="ok">å¯†ç å¼ºåº¦é€šè¿‡</span>'; $('btn-backup').disabled=false;
    };
    $('btn-backup').onclick = async ()=>{
      try{
        if (!mnemonic){ alert('è¯·å…ˆç”ŸæˆåŠ©è®°è¯'); return; }
        const { blob } = await createPasswordBackupBlob(mnemonic, $('pw1').value);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='mnemonic_backup.enc.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 3000);
        $('pw-tip').innerHTML = '<span class="ok">å·²ç”Ÿæˆå¹¶ä¸‹è½½ã€‚</span>';
      }catch(e){ $('pw-tip').innerHTML='<span class="err">å¤±è´¥ï¼š'+(e?.message||e)+'</span>'; }
    };

    $('btn-register').onclick = async () => {
      try {
        const res = await registerCredentialIfNeeded();
        if (res?.created) $('reg-tip').innerHTML = '<span class="ok">å·²æ³¨å†Œæ–°å‡­è¯ã€‚</span>';
        else $('reg-tip').innerHTML = '<span class="ok">å·²å¤ç”¨å‡­è¯ã€‚</span>';
      } catch (e) {
        $('reg-tip').innerHTML = '<span class="err">å¤±è´¥ï¼š' + (e?.message||e) + '</span>';
      }
    };

    $('btn-encrypt').onclick = async () => {
      try {
        if (!branches) { alert('è¯·å…ˆç”ŸæˆåŠ©è®°è¯'); return; }
        $('encrypt-tip').textContent = 'è¯·è§¦æ‘¸å¯†é’¥ä»¥ç»§ç»­â€¦';

        const { kek, salt, rp_id, info, credential_id, toHex } = await deriveKEK();
        const enc = async s => s ? await aesGcmEncryptStr(kek, s) : null;

        const bundle = {
          KEKInfo: { rp_id, info, salt: toHex(salt), credential_id },
          chains: {
            ETH:  { path: branches.ETH.path,  PubEnc: await enc(branches.ETH.xpub),   PrivEnc: await enc(branches.ETH.xprv) },
            BTC:  { path: branches.BTC.path,  PubEnc: await enc(branches.BTC.xpub_z), PrivEnc: await enc(branches.BTC.xprv_z) },
            EOS:  { path: branches.EOS.path,  PubEnc: await enc(branches.EOS.xpub),   PrivEnc: await enc(branches.EOS.xprv) },
            TRON: { path: branches.TRON.path, PubEnc: await enc(branches.TRON.xpub),  PrivEnc: await enc(branches.TRON.xprv) },
          }
        };

        $('encrypt-tip').textContent = 'æ­£åœ¨å†™å…¥æ•°æ®åº“â€¦';

        const resp = await fetch('https://wallet.lucas-l-shang.workers.dev/bundles', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ user_id: 'web-ui', note: 'UI init save', bundle })
        });
        const data = await resp.json().catch(()=> ({}));
        if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

        mnemonic = '';
        branches = null;
        $('encrypt-tip').textContent = '';
        $('final-tip').innerHTML = `<span class="ok">æ³¨å†ŒæˆåŠŸï¼bundle_id=${data.bundle_id}</span>`;
      } catch (e) {
        $('encrypt-tip').textContent = '';
        $('final-tip').innerHTML = `<span class="err">å†™å…¥å¤±è´¥ï¼š${e?.message||e}</span>`;
      }
    };
  </script>
</body>
</html>
